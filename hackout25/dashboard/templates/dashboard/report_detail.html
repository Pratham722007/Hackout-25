{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ report.title }} - Environmental Report{% endblock %}

{% block content %}
<div class="header-section">
    <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
            <div class="mb-3">
                <a href="{% url 'reports' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Back to Reports
                </a>
            </div>
            <h1 class="mb-2">{{ report.title }}</h1>
            <div class="d-flex align-items-center mb-3">
                <span class="risk-badge risk-{{ report.risk_level }} me-3">
                    {% if report.risk_level == 'critical' %}üö®{% elif report.risk_level == 'high' %}‚ö†Ô∏è{% else %}‚úÖ{% endif %}
                    {{ report.get_risk_level_display }} Risk
                </span>
                <span class="status-badge status-{{ report.status }}">{{ report.get_status_display }}</span>
            </div>
            <div class="text-muted">
                <i class="fas fa-map-marker-alt me-1"></i>{{ report.location }}
                <span class="mx-2">‚Ä¢</span>
                <i class="fas fa-clock me-1"></i>{{ report.created_at|date:"F d, Y \a\t g:i A" }}
            </div>
        </div>
        <div class="text-end">
            <div class="mb-2">
                <span class="text-muted small">AI Confidence Score</span>
            </div>
            <div class="d-flex align-items-center">
                <div class="progress me-3" style="width: 120px; height: 10px;">
                    <div class="progress-bar 
                        {% if report.confidence >= 80 %}bg-success
                        {% elif report.confidence >= 50 %}bg-warning
                        {% else %}bg-danger{% endif %}" 
                         style="width: {{ report.confidence }}%"></div>
                </div>
                <h4 class="mb-0 
                    {% if report.confidence >= 80 %}text-success
                    {% elif report.confidence >= 50 %}text-warning
                    {% else %}text-danger{% endif %}">{{ report.confidence }}%</h4>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Image Section -->
        {% if report.image %}
        <div class="content-card">
            <h5><i class="fas fa-image me-2"></i>Environmental Image</h5>
            <div class="text-center">
                <img src="{{ report.image.url }}" alt="{{ report.title }}" class="img-fluid rounded shadow-sm" style="max-height: 500px;">
            </div>
        </div>
        {% endif %}

        <!-- Description -->
        <div class="content-card">
            <h5><i class="fas fa-file-text me-2"></i>Description</h5>
            {% if report.description %}
                <p style="line-height: 1.8; font-size: 16px;">{{ report.description|linebreaks }}</p>
            {% else %}
                <p class="text-muted fst-italic">No description provided for this environmental report.</p>
            {% endif %}
        </div>

        <!-- AI Analysis Results -->
        <div class="content-card">
            <h5><i class="fas fa-brain me-2"></i>AI Analysis Results</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="bg-light p-3 rounded">
                        <h6 class="text-muted mb-2">Risk Assessment</h6>
                        <div class="d-flex align-items-center">
                            {% if report.risk_level == 'critical' %}
                                <i class="fas fa-exclamation-triangle text-danger fa-2x me-3"></i>
                                <div>
                                    <strong class="text-danger">Critical Risk</strong>
                                    <p class="mb-0 small text-muted">Immediate attention required</p>
                                </div>
                            {% elif report.risk_level == 'high' %}
                                <i class="fas fa-exclamation-circle text-warning fa-2x me-3"></i>
                                <div>
                                    <strong class="text-warning">High Risk</strong>
                                    <p class="mb-0 small text-muted">Urgent action needed</p>
                                </div>
                            {% else %}
                                <i class="fas fa-check-circle text-success fa-2x me-3"></i>
                                <div>
                                    <strong class="text-success">Low Risk</strong>
                                    <p class="mb-0 small text-muted">Monitoring recommended</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="bg-light p-3 rounded">
                        <h6 class="text-muted mb-2">Analysis Status</h6>
                        <div class="d-flex align-items-center">
                            {% if report.status == 'completed' %}
                                <i class="fas fa-check-circle text-success fa-2x me-3"></i>
                                <div>
                                    <strong class="text-success">Completed</strong>
                                    <p class="mb-0 small text-muted">Analysis finished</p>
                                </div>
                            {% elif report.status == 'flagged' %}
                                <i class="fas fa-flag text-danger fa-2x me-3"></i>
                                <div>
                                    <strong class="text-danger">Flagged</strong>
                                    <p class="mb-0 small text-muted">Requires review</p>
                                </div>
                            {% elif report.status == 'mixed' %}
                                <i class="fas fa-question-circle text-warning fa-2x me-3"></i>
                                <div>
                                    <strong class="text-warning">Mixed Results</strong>
                                    <p class="mb-0 small text-muted">Uncertain outcome</p>
                                </div>
                            {% else %}
                                <i class="fas fa-question text-secondary fa-2x me-3"></i>
                                <div>
                                    <strong class="text-secondary">Unknown</strong>
                                    <p class="mb-0 small text-muted">Needs verification</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="bg-light p-3 rounded">
                        <h6 class="text-muted mb-2">AI Confidence</h6>
                        <div class="d-flex align-items-center">
                            {% if report.confidence >= 80 %}
                                <i class="fas fa-thumbs-up text-success fa-2x me-3"></i>
                                <div>
                                    <strong class="text-success">High Confidence</strong>
                                    <p class="mb-0 small text-muted">Very reliable</p>
                                </div>
                            {% elif report.confidence >= 50 %}
                                <i class="fas fa-thumbs-up text-warning fa-2x me-3"></i>
                                <div>
                                    <strong class="text-warning">Medium Confidence</strong>
                                    <p class="mb-0 small text-muted">Moderately reliable</p>
                                </div>
                            {% else %}
                                <i class="fas fa-thumbs-down text-danger fa-2x me-3"></i>
                                <div>
                                    <strong class="text-danger">Low Confidence</strong>
                                    <p class="mb-0 small text-muted">Needs verification</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Location Map -->
        {% if report.latitude and report.longitude %}
        <div class="content-card">
            <h5><i class="fas fa-map-marked-alt me-2"></i>Location</h5>
            <div class="mb-3">
                <strong>Coordinates:</strong><br>
                <span class="font-monospace">{{ report.latitude|floatformat:6 }}, {{ report.longitude|floatformat:6 }}</span>
            </div>
            <div class="mb-3">
                <!-- Embedded map -->
                <iframe 
                    src="https://www.openstreetmap.org/export/embed.html?bbox={{ report.longitude|add:-0.01 }},{{ report.latitude|add:-0.01 }},{{ report.longitude|add:0.01 }},{{ report.latitude|add:0.01 }}&layer=mapnik&marker={{ report.latitude }},{{ report.longitude }}"
                    width="100%" 
                    height="250"
                    frameborder="0"
                    class="rounded">
                </iframe>
            </div>
            <div class="d-grid">
                <a href="https://www.google.com/maps?q={{ report.latitude }},{{ report.longitude }}" target="_blank" class="btn btn-outline-primary">
                    <i class="fas fa-external-link-alt me-2"></i>Open in Google Maps
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Report Metadata -->
        <div class="content-card">
            <h5><i class="fas fa-info-circle me-2"></i>Report Information</h5>
            <table class="table table-sm">
                <tr>
                    <th>Report ID:</th>
                    <td><span class="font-monospace">#{{ report.id|stringformat:"05d" }}</span></td>
                </tr>
                <tr>
                    <th>Created:</th>
                    <td>{{ report.created_at|date:"F d, Y \a\t g:i A" }}</td>
                </tr>
                <tr>
                    <th>Location:</th>
                    <td>{{ report.location }}</td>
                </tr>
                <tr>
                    <th>Risk Level:</th>
                    <td>
                        <span class="risk-badge risk-{{ report.risk_level }}">
                            {{ report.get_risk_level_display }}
                        </span>
                    </td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td>
                        <span class="status-badge status-{{ report.status }}">
                            {{ report.get_status_display }}
                        </span>
                    </td>
                </tr>
                <tr>
                    <th>AI Confidence:</th>
                    <td>
                        <strong class="
                            {% if report.confidence >= 80 %}text-success
                            {% elif report.confidence >= 50 %}text-warning
                            {% else %}text-danger{% endif %}">{{ report.confidence }}%</strong>
                    </td>
                </tr>
                {% if report.latitude and report.longitude %}
                <tr>
                    <th>GPS Coordinates:</th>
                    <td class="font-monospace small">
                        {{ report.latitude|floatformat:6 }},<br>
                        {{ report.longitude|floatformat:6 }}
                    </td>
                </tr>
                {% endif %}
            </table>
        </div>

        <!-- Actions -->
        <div class="content-card">
            <h5><i class="fas fa-tools me-2"></i>Actions</h5>
            <div class="d-grid gap-2">
                {% if report.image %}
                <a href="{{ report.image.url }}" target="_blank" class="btn btn-outline-primary">
                    <i class="fas fa-download me-2"></i>Download Image
                </a>
                {% endif %}
                <button class="btn btn-outline-info" onclick="shareReport()">
                    <i class="fas fa-share-alt me-2"></i>Share Report
                </button>
                <a href="{% url 'reports' %}" class="btn btn-secondary">
                    <i class="fas fa-list me-2"></i>View All Reports
                </a>
            </div>
        </div>

        <!-- AI Model Information -->
        <div class="content-card">
            <h5><i class="fas fa-robot me-2"></i>AI Analysis Details</h5>
            <div class="small text-muted">
                <p><strong>Model:</strong> MobileNetV2 with Transfer Learning</p>
                <p><strong>Techniques:</strong> Computer Vision, Multi-class Classification</p>
                <p><strong>Features:</strong> Environmental content detection, Risk assessment, Color analysis</p>
                <p class="mb-0"><strong>Accuracy:</strong> 94.5% on environmental datasets</p>
            </div>
        </div>
    </div>
</div>

<script>
function shareReport() {
    const reportData = {
        title: "{{ report.title|escapejs }}",
        text: "Check out this environmental report: {{ report.title|escapejs }}",
        url: window.location.href
    };

    if (navigator.share) {
        navigator.share(reportData)
            .then(() => console.log('Report shared successfully'))
            .catch((error) => console.log('Error sharing report:', error));
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href)
            .then(() => {
                alert('Report URL copied to clipboard!');
            })
            .catch(() => {
                alert('Unable to share. Report URL: ' + window.location.href);
            });
    }
}
</script>
{% endblock %}
